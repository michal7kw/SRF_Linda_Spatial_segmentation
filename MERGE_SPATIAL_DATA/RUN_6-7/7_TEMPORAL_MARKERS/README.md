# Temporal Markers Analysis

This directory contains scripts and results for identifying temporal gene markers by comparing control (ctrl) vs mutant (mut) samples at corresponding time points in spatial transcriptomics data.

## Overview

The analysis performs differential expression analysis between ctrl and mut samples for each time point where both sample types are available. This allows identification of genes that are consistently dysregulated in mutant samples across different developmental stages.

## Data Structure

The analysis is based on the following sample mapping:

```python
data_map = {
    'p0-p7': {
        'R1': {'time_point': 'p7', 'region': 'R1', 'type': 'mut'},
        'R2': {'time_point': 'p7', 'region': 'R2', 'type': 'ctrl'},
        'R4': {'time_point': 'p30', 'region': 'R4p', 'type': 'ctrl'},
        'R5': {'time_point': 'p0', 'region': 'R5p', 'type': 'mut'},
        'R6': {'time_point': 'p0', 'region': 'R6', 'type': 'ctrl'}
    },
    'p30-E165': {
        'R1': {'time_point': 'e16', 'region': 'R1', 'type': 'mut'},
        'R2': {'time_point': 'e16', 'region': 'R2', 'type': 'ctrl'},
        'R3': {'time_point': 'p30', 'region': 'R3', 'type': 'mut'}
    }
}
```

## Comparisons Performed

The script automatically identifies time points where both ctrl and mut samples are available and performs the following comparisons:

- **p0**: mut (R5) vs ctrl (R6)
- **p7**: mut (R1) vs ctrl (R2)
- **p30**: mut (R3) vs ctrl (R4)
- **e16**: mut (R1) vs ctrl (R2)

## Files

### Scripts
- `temporal_markers_analysis.py`: Main analysis script

### Input Data
- Requires: `../merged_spatial_data_hippo_inclusive.h5ad` (generated by merge script)

### Output Files

All results are saved in the `results/` subdirectory:

#### Individual Time Point Results
- `de_results_{timepoint}_mut_vs_ctrl.csv`: Differential expression results for each time point
- `volcano_plot_{timepoint}_mut_vs_ctrl.png`: Volcano plots showing significance vs fold change
- `heatmap_{timepoint}_top_genes.png`: Heatmaps of top differentially expressed genes

#### Summary Files
- `combined_de_results_all_timepoints.csv`: Combined results from all time points
- `summary_statistics.csv`: Summary statistics for each comparison
- `summary_barplot.png`: Bar plots showing number of significant genes per time point

## Analysis Workflow

### 1. Data Loading
- Loads merged spatial data from the hippo-specific analysis
- Validates presence of required metadata (time_point, type, region)

### 2. Differential Expression Analysis
- Uses Wilcoxon rank-sum test for statistical testing
- Compares mut vs ctrl for each time point
- Applies multiple testing correction (Benjamini-Hochberg)

### 3. Significance Thresholds
- **Adjusted p-value**: < 0.05
- **Log2 fold change**: |log2FC| > 0.5
- Genes meeting both criteria are classified as significantly up/downregulated

### 4. Visualization
- **Volcano plots**: Show relationship between fold change and statistical significance
- **Heatmaps**: Display expression patterns of top differentially expressed genes
- **Summary plots**: Overview of results across all time points

## Usage

### Prerequisites
1. Ensure the merged spatial data file exists:
   ```bash
   ls ../merged_spatial_data_hippo_inclusive.h5ad
   ```

2. Required Python packages:
   - scanpy
   - pandas
   - numpy
   - matplotlib
   - seaborn
   - scipy

### Running the Analysis

```bash
# Navigate to the project root
cd /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/SRF_Spatial_segmentation

# Run the analysis
python MERGE_SPATIAL_DATA/7_TEMPORAL_MARKERS/temporal_markers_analysis.py
```

### Expected Runtime
- Typical runtime: 5-15 minutes depending on data size
- Memory usage: ~2-4 GB RAM

## Output Interpretation

### Differential Expression Results
Each CSV file contains the following columns:
- `names`: Gene names
- `logfoldchanges`: Log2 fold change (mut vs ctrl)
- `pvals`: Raw p-values
- `pvals_adj`: Adjusted p-values (Benjamini-Hochberg)
- `regulation`: Classification (upregulated/downregulated/not_significant)
- `time_point`: Time point identifier

### Summary Statistics
- `total_genes`: Total number of genes tested
- `significant_genes`: Number of significantly differentially expressed genes
- `upregulated`: Number of upregulated genes in mut vs ctrl
- `downregulated`: Number of downregulated genes in mut vs ctrl
- `pct_significant`: Percentage of genes that are significantly different

## Quality Control

The script includes several QC checks:
- Validates presence of both ctrl and mut samples for each time point
- Reports sample sizes for each comparison
- Filters genes present in the dataset
- Handles edge cases (e.g., no significant genes found)

## Troubleshooting

### Common Issues

1. **Missing input file**:
   ```
   Error: Merged data file not found
   ```
   Solution: Run the merge script first to generate the required input file.

2. **No significant genes found**:
   - Check if the comparison has sufficient statistical power
   - Consider adjusting significance thresholds
   - Verify data quality and preprocessing steps

3. **Memory issues**:
   - Reduce the number of genes analyzed
   - Use a machine with more RAM
   - Consider subsetting the data

### Log Files
The script provides detailed console output including:
- Number of cells per comparison
- Number of significant genes found
- File paths for saved results

## Next Steps

After running this analysis, you can:

1. **Gene Set Enrichment Analysis**: Use the significant gene lists for pathway analysis
2. **Temporal Trajectory Analysis**: Compare how gene expression changes across time points
3. **Cross-validation**: Validate findings using independent datasets
4. **Functional Annotation**: Investigate biological functions of identified markers

## Contact

For questions or issues with this analysis, please refer to the project documentation or contact the bioinformatics team.